<?php require('check.php');
require_once('settings.php'); 
include('header.php');

if(!$_SERVER['QUERY_STRING']) {
	?>
	<h1>Add a Member</h1>
	Use this form to add a member to the database. <b>If the member has submitted a join form, they are already in the database!</b> Use the <a href="edit_mem.php">edit</a> form to update information for existing members.
	<br /><br />
	<form method="post" action="add_mem.php?added">
	<input type="hidden" name="status" value="Pending" />
	<input type="hidden" name="level" value="1" />
	<input type="hidden" name="membercard" value="No" />
	<input type="hidden" name="mastered" value="None" />
	<input type="hidden" name="wishlist" value="Coming Soon" />
	<input type="hidden" name="biography" value="Coming Soon" />
	<table>
	<tr><td><b>Name:</b></td><td><input type="text" name="name" /></td></tr>
	<tr><td><b>Email:</b></td><td><input type="text" name="email" /></td></tr>
	<tr><td><b>URL:</b></td><td><input type="text" name="url" /></td></tr>
	<tr><td><b>Birthday:</b></td><td><select name="birthday">
	<option value="">-----</option>
	<option value="Jan">Jan.</option>
	<option value="Feb">Feb.</option>
	<option value="Mar">Mar.</option>
	<option value="Apr">Apr.</option>
	<option value="May">May</option>
	<option value="Jun">June</option>
	<option value="Jul">July</option>
	<option value="Aug">Aug.</option>
	<option value="Sep">Sept.</option>
	<option value="Oct">Oct.</option>
	<option value="Nov">Nov.</option>
	<option value="Dec">Dec.</option>
	</select></td></tr>
	<tr><td><b>Collecting:</b></td><td><select name="collecting">
	<option value="">-----</option>
	<?php
	$query_collect = "SELECT * FROM `$table_cards` ORDER BY `description` ASC";
	$result_collect = mysql_query($query_collect);
	while($row_collect=mysql_fetch_assoc($result_collect)) {
		echo "<option value=\"$row_collect[filename]\">$row_collect[description] ($row_collect[filename])</option>\n";
	}
	?>
	</select></td></tr>
	<tr><td><b>Password:</b></td><td><input type="text" name="password" value="resetme" /></td></tr>
	<tr><td>&nbsp;</td><td><input type="submit" name="submit" value=" Add! " /></td></tr>
	</table>
	</form>
	<?php
}

elseif($_SERVER['QUERY_STRING']=="added") {
	if (!isset($_POST['submit']) || $_SERVER['REQUEST_METHOD'] != "POST") {	    exit("<p>You did not press the submit button; this page should not be accessed directly.</p>");	}
	else {	    $exploits = "/(content-type|bcc:|cc:|document.cookie|onclick|onload|javascript|alert)/i";	    $profanity = "/(beastial|bestial|blowjob|clit|cum|cunilingus|cunillingus|cunnilingus|cunt|ejaculate|fag|felatio|fellatio|fuck|fuk|fuks|gangbang|gangbanged|gangbangs|hotsex|jism|jiz|kock|kondum|kum|kunilingus|orgasim|orgasims|orgasm|orgasms|phonesex|phuk|phuq|porn|pussies|pussy|spunk|xxx)/i";	    $spamwords = "/(viagra|phentermine|tramadol|adipex|advai|alprazolam|ambien|ambian|amoxicillin|antivert|blackjack|backgammon|texas|holdem|poker|carisoprodol|ciara|ciprofloxacin|debt|dating|porn)/i";	    $bots = "/(Indy|Blaiz|Java|libwww-perl|Python|OutfoxBot|User-Agent|PycURL|AlphaServer)/i";	    if (preg_match($bots, $_SERVER['HTTP_USER_AGENT'])) {	        exit("<h1>Error</h1>\nKnown spam bots are not allowed.");	    }	    foreach ($_POST as $key => $value) {	        $value = trim($value);	        if (empty($_POST['name']) || empty($_POST['email']) || empty($_POST['url']) || empty($_POST['collecting'])) {	            exit("<h1>Error</h1>\nName, email, URL, and Collecting are all required fields. Please go back and complete the form.");	        }
	        elseif (preg_match($exploits, $value)) {	            exit("<h1>Error</h1>\nExploits/malicious scripting attributes aren't allowed.");	        }
	        elseif (preg_match($profanity, $value) || preg_match($spamwords, $value)) {	            exit("<h1>Error</h1>\nThat kind of language is not allowed through this form.");	        }	        $_POST[$key] = stripslashes(strip_tags($value));	    }	    if (!ereg("^[_a-z0-9-]+(.[_a-z0-9-]+)*@[a-z0-9-]+(.[a-z0-9-]+)*(.[a-z]{2,6})$",strtolower($_POST['email']))) {	        exit("<h1>Error</h1>\nThat e-mail address is not valid, please use another.");	    }	    $name = escape_sql(CleanUp($_POST['name']));
		$email = escape_sql(CleanUp($_POST['email']));
		$url = escape_sql(CleanUp($_POST['url']));
		$birthday = escape_sql(CleanUp($_POST['birthday']));
		$password = escape_sql(CleanUp($_POST['password']));
		$status = escape_sql(CleanUp($_POST['status']));
		$level = escape_sql(CleanUp($_POST['level']));
		$collecting = escape_sql(CleanUp($_POST['collecting']));
		$membercard = escape_sql(CleanUp($_POST['membercard']));
		$mastered = escape_sql(CleanUp($_POST['masters']));
		$wishlist = escape_sql(CleanUp($_POST['wishlist']));
		$biography = escape_sql(CleanUp($_POST['biography']));
	
		$insert = "INSERT INTO `$table_members` (`id`, `name`, `email`, `url`, `birthday`, `password`, `status`, `level`, `collecting`, `membercard`, `mastered`, `wishlist`, `biography`) VALUES ('', '$name', '$email', '$url', '$birthday', 'md5($password)', '$status', '$level', '$collecting', '$membercard', '$mastered', '$wishlist', '$biography')";	    if (mysql_query($insert, $connect)) {	        echo "<h1>Success</h1>\n";
	        echo "The member was successfully added to the database.\n";
	        echo "Want to <a href=\"add_mem.php\">add</a> another?";	    }
	    else {
	    	echo "<h1>Error</h1>\n";	        echo "Sorry, there was an error and the member was not added.<br />\n";
	        die("Error:". mysql_error());	    }	}
}include('footer.php'); ?>