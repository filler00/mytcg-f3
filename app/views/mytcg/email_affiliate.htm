<?php require('check.php');
require_once('settings.php'); 
include('header.php');

if(!$_SERVER['QUERY_STRING']) {
	?>
	<h1>Error</h1>
	This page shouldn't be accessed directly! Please go back and try something else.
	<?php
}

elseif($_SERVER['QUERY_STRING']=="email") {
	if (!isset($_POST['submit']) || $_SERVER['REQUEST_METHOD'] != "POST") {	    exit("<p>You did not press the submit button; this page should not be accessed directly.</p>");	}
	else {	    $exploits = "/(content-type|bcc:|cc:|document.cookie|onclick|onload|javascript|alert)/i";	    $profanity = "/(beastial|bestial|blowjob|clit|cum|cunilingus|cunillingus|cunnilingus|cunt|ejaculate|fag|felatio|fellatio|fuck|fuk|fuks|gangbang|gangbanged|gangbangs|hotsex|jism|jiz|kock|kondum|kum|kunilingus|orgasim|orgasims|orgasm|orgasms|phonesex|phuk|phuq|porn|pussies|pussy|spunk|xxx)/i";	    $spamwords = "/(viagra|phentermine|tramadol|adipex|advai|alprazolam|ambien|ambian|amoxicillin|antivert|blackjack|backgammon|texas|holdem|poker|carisoprodol|ciara|ciprofloxacin|debt|dating|porn)/i";	    $bots = "/(Indy|Blaiz|Java|libwww-perl|Python|OutfoxBot|User-Agent|PycURL|AlphaServer)/i";	    if (preg_match($bots, $_SERVER['HTTP_USER_AGENT'])) {	        exit("<h1>Error</h1>\nKnown spam bots are not allowed.");	    }	    foreach ($_POST as $key => $value) {	        $value = trim($value);	        if (empty($value)) {	            exit("<h1>Error</h1>\nAll fields are required. Please go back and complete the form.");	        }
	        elseif (preg_match($exploits, $value)) {	            exit("<h1>Error</h1>\nExploits/malicious scripting attributes aren't allowed.");	        }
	        elseif (preg_match($profanity, $value) || preg_match($spamwords, $value)) {	            exit("<h1>Error</h1>\nThat kind of language is not allowed through this form.");	        }	        $_POST[$key] = stripslashes(strip_tags($value));	    }
	    
	    $select=mysql_query("SELECT * FROM `$table_affiliates` WHERE `id`=$_POST[id]");
	    while($row=mysql_fetch_assoc($select)) {
	    	    	$recipient = "$row[email]";
			$subject = "$tcgname: Affiliate Contact Form";
			
			$message = "$tcgowner at $tcgname has sent you the following message: \n";
			$message .= "{$_POST['message']} \n\n";
			$message .= "-- $tcgowner\n";
			$message .= "$tcgname: $tcgurl\n";
		
			$headers = "From: $tcgname <$tcgemail> \n";
			$headers .= "Reply-To: $tcgname <$tcgemail>";	    	if (mail($recipient,$subject,$message,$headers)) {	    	    echo "<h1>Success</h1>\n";
	    	    echo "Your message to $row[name] @ $row[email] from $row[tcgname] has been successfully sent!";
	    	}
	    	else {
	    		echo "<h1>Error</h1>\n";	    	    echo "Sorry, there was an error and the email could not be sent to $row[name] @ $row[email] from $row[tcgname].";
	    	}
	    }	}
}

else {
	$id=$_GET['id'];
	$getdata = mysql_query("SELECT * FROM `$table_affiliates` WHERE id='$id'");
	while($row=mysql_fetch_assoc($getdata)) {
		?>
		<h1>Email <?php echo $row[name]; ?> at <?php echo $row[tcgname]; ?></h1>
		Use this form to send an email to <?php echo $row[name]; ?>, owner of <?php echo $row[tcgname]; ?>. <b>This is not the form for sending an email to all affiliates.</b> If you need to send an email to all of the affiliates of <?php echo $tcgname; ?>, please use <a href="email_allaffiliates.php">this form</a>.
		<br /><br />
		<form method="post" action="email_affiliate.php?email">
		<input type="hidden" name="id" value="<?php echo $id; ?>" />
		<table>
		<tr><td><b>To:</b></td><td><?php echo $row[name]; ?> @ <?php echo $row[tcgname]; ?></td></tr>
		<tr><td valign="top"><b>Message:</b></td><td><textarea name="message" rows="5" cols="50"></textarea></td></tr>
		<tr><td>&nbsp;</td><td><input type="submit" name="submit" value=" Send! " /></td></tr>
		</table>
		</form>
		<?php
	}
}include('footer.php'); ?>